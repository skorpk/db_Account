USE AccountOMS
GO
DECLARE @dateStart DATETIME='20200101',
		@dateEnd DATETIME='20210116',
		@dateEndPay DATETIME='20210119'

CREATE TABLE #tDiag(DS1 VARCHAR(6))

INSERT #tDiag
(
    DS1
)
VALUES('P00'), ('P00.0'), ('P00.1'), ('P00.2'), ('P00.3'), ('P00.4'), ('P00.5'), ('P00.6'), ('P00.7'), ('P00.8'), ('P00.9'), ('P01'), ('P01.0'), ('P01.1'), ('P01.2'), 
('P01.3'), ('P01.4'), ('P01.5'), ('P01.6'), ('P01.7'), ('P01.8'), ('P01.9'), ('P02'), ('P02.0'), ('P02.1'), ('P02.2'), ('P02.3'), ('P02.4'), ('P02.5'), ('P02.6'), 
('P02.7'), ('P02.8'), ('P02.9'), ('P03'), ('P03.0'), ('P03.1'), ('P03.2'), ('P03.3'), ('P03.4'), ('P03.5'), ('P03.6'), ('P03.8'), ('P03.9'), ('P04'), ('P04.0'), 
('P04.1'), ('P04.2'), ('P04.3'), ('P04.4'), ('P04.5'), ('P04.6'), ('P04.8'), ('P04.9'), ('P05'), ('P05.0'), ('P05.1'), ('P05.2'), ('P05.9'), ('P07'), ('P07.0'), 
('P07.1'), ('P07.2'), ('P07.3'), ('P08'), ('P08.0'), ('P08.1'), ('P08.2'), ('P10'), ('P10.0'), ('P10.1'), ('P10.2'), ('P10.3'), ('P10.4'), ('P10.8'), ('P10.9'), 
('P11'), ('P11.0'), ('P11.1'), ('P11.2'), ('P11.3'), ('P11.4'), ('P11.5'), ('P11.9'), ('P12'), ('P12.0'), ('P12.1'), ('P12.2'), ('P12.3'), ('P12.4'), ('P12.8'), 
('P12.9'), ('P13'), ('P13.0'), ('P13.1'), ('P13.2'), ('P13.3'), ('P13.4'), ('P13.8'), ('P13.9'), ('P14'), ('P14.0'), ('P14.1'), ('P14.2'), ('P14.3'), ('P14.8'),
('P14.9'), ('P15'), ('P15.0'), ('P15.1'), ('P15.2'), ('P15.3'), ('P15.4'), ('P15.5'), ('P15.6'), ('P15.8'), ('P15.9'), ('P20'), ('P20.0'), ('P20.1'), ('P20.9'), 
('P21'), ('P21.0'), ('P21.1'), ('P21.9'), ('P22'), ('P22.0'), ('P22.1'), ('P22.8'), ('P22.9'), ('P23'), ('P23.0'), ('P23.1'), ('P23.2'), ('P23.3'), ('P23.4'), 
('P23.5'), ('P23.6'), ('P23.8'), ('P23.9'), ('P24'), ('P24.0'), ('P24.1'), ('P24.2'), ('P24.3'), ('P24.8'), ('P24.9'), ('P25'), ('P25.0'), ('P25.1'), ('P25.2'), 
('P25.3'), ('P25.8'), ('P26'), ('P26.0'), ('P26.1'), ('P26.8'), ('P26.9'), ('P27'), ('P27.0'), ('P27.1'), ('P27.8'), ('P27.9'), ('P28'), ('P28.0'), ('P28.1'),
('P28.2'), ('P28.3'), ('P28.4'), ('P28.5'), ('P28.8'), ('P28.9'), ('P29'), ('P29.0'), ('P29.1'), ('P29.2'), ('P29.3'), ('P29.4'), ('P29.8'), ('P29.9'), ('P35'), 
('P35.0'), ('P35.1'), ('P35.2'), ('P35.3'), ('P35.4'), ('P35.8'), ('P35.9'), ('P36'), ('P36.0'), ('P36.1'), ('P36.2'), ('P36.3'), ('P36.4'), ('P36.5'), ('P36.8'), 
('P36.9'), ('P37'), ('P37.0'), ('P37.1'), ('P37.2'), ('P37.3'), ('P37.4'), ('P37.5'), ('P37.8'), ('P37.9'), ('P38'), ('P39'), ('P39.0'), ('P39.1'), ('P39.2'), ('P39.3'), 
('P39.4'), ('P39.8'), ('P39.9'), ('P50'), ('P50.0'), ('P50.1'), ('P50.2'), ('P50.3'), ('P50.4'), ('P50.5'), ('P50.8'), ('P50.9'), ('P51'), ('P51.0'), ('P51.8'), ('P51.9'), 
('P52'), ('P52.0'), ('P52.1'), ('P52.2'), ('P52.3'), ('P52.4'), ('P52.5'), ('P52.6'), ('P52.8'), ('P52.9'), ('P53'), ('P54'), ('P54.0'), ('P54.1'), ('P54.2'), ('P54.3'), 
('P54.4'), ('P54.5'), ('P54.6'), ('P54.8'), ('P54.9'), ('P55'), ('P55.0'), ('P55.1'), ('P55.8'), ('P55.9'), ('P56'), ('P56.0'), ('P56.9'), ('P57'), ('P57.0'), ('P57.8'),
('P57.9'), ('P58'), ('P58.0'), ('P58.1'), ('P58.2'), ('P58.3'), ('P58.4'), ('P58.5'), ('P58.8'), ('P58.9'), ('P59'), ('P59.0'), ('P59.1'), ('P59.2'), ('P59.3'), ('P59.8'),
('P59.9'), ('P60'), ('P61'), ('P61.0'), ('P61.1'), ('P61.2'), ('P61.3'), ('P61.4'), ('P61.5'), ('P61.6'), ('P61.8'), ('P61.9'), ('P70'), ('P70.0'), ('P70.1'), ('P70.2'), 
('P70.3'), ('P70.4'), ('P70.8'), ('P70.9'), ('P71'), ('P71.0'), ('P71.1'), ('P71.2'), ('P71.3'), ('P71.4'), ('P71.8'), ('P71.9'), ('P72'), ('P72.0'), ('P72.1'), ('P72.2'),
('P72.8'), ('P72.9'), ('P74'), ('P74.0'), ('P74.1'), ('P74.2'), ('P74.3'), ('P74.4'), ('P74.5'), ('P74.8'), ('P74.9'), ('P75'), ('P76'), ('P76.0'), ('P76.1'), ('P76.2'), 
('P76.8'), ('P76.9'), ('P77'), ('P78'), ('P78.0'), ('P78.1'), ('P78.2'), ('P78.3'), ('P78.8'), ('P78.9'), ('P80'), ('P80.0'), ('P80.8'), ('P80.9'), ('P81'), ('P81.0'),
('P81.8'), ('P81.9'), ('P83'), ('P83.0'), ('P83.1'), ('P83.2'), ('P83.3'), ('P83.4'), ('P83.5'), ('P83.6'), ('P83.8'), ('P83.9'), ('P90'), ('P91'), ('P91.0'), ('P91.1'),
('P91.2'), ('P91.3'), ('P91.4'), ('P91.5'), ('P91.6'), ('P91.7'), ('P91.8'), ('P91.9')


SELECT DISTINCT c.id AS rf_idCase, f.CodeM, c.AmountPayment,c.rf_idRecordCasePatient,dd.DS1,c.KD, c.AmountPayment AS AmmPay
INTO #tCases
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts
					INNER JOIN dbo.t_Case c ON
			r.id=c.rf_idRecordCasePatient											
					INNER JOIN dbo.t_Diagnosis d ON
            c.id=d.rf_idCase
			AND d.TypeDiagnosis=1
					JOIN #tDiag dd ON
            d.DiagnosisCode=dd.DS1
WHERE f.DateRegistration>@dateStart AND f.DateRegistration<@dateEnd AND a.ReportYear=2020 AND c.rf_idV006=1 AND f.CodeM='106001'

UPDATE p SET p.AmountPayment=p.AmountPayment-r.AmountDeduction
FROM #tCases p INNER JOIN (SELECT c.rf_idCase,SUM(c.AmountDeduction) AS AmountDeduction
								FROM dbo.t_PaymentAcceptedCase2 c
								WHERE c.DateRegistration>=@dateStart AND c.DateRegistration<@dateEndPay
								GROUP BY c.rf_idCase
							) r ON
			p.rf_idCase=r.rf_idCase

DELETE FROM #tCases WHERE AmountPayment=0.0

SELECT d.DS1,ISNULL(COUNT(DISTINCT c.rf_idRecordCasePatient),0) AS CountCase, SUM(ISNULL(c.KD,0)) AS SumKD,SUM(ISNULL(c.AmmPay,0))
FROM #tDiag d LEFT JOIN #tCases c ON
		d.DS1=c.DS1
GROUP BY d.DS1
ORDER BY d.DS1
GO
DROP TABLE #tDiag
GO
DROP TABLE #tCases