USE AccountOMS
go
CREATE TABLE #t(ENP VARCHAR(20))
INSERT #t values('3452020839000796'),('3471360887000059'),('3470360895000191'),('3455040892000159'),('3477060885000200'),('3468060886000101')
,('3458640879000010'),('3448140894000015'),('3453630828000083'),('3477650879000305'),('3451030836000377'),('3456240831000273'),('3450540882000080')
,('3449830842000021'),('3451540842000104'),('3474360883000258'),('3478940871000638'),('3448240886000039'),('3477950880000017'),('3471450898000022')
,('3456530896000550'),('3454930884000467'),('3452130876000326'),('3450640829000019'),('3449540892000231'),('3478060843000143'),('3448530885000018')
,('3447540835000001'),('3474450870000187'),('3455840841000279'),('3450640873000022'),('3477250893000199'),('3469350839000418'),('3468250874000235')
,('3454230898000672'),('3458140825000107'),('3475650877000010'),('3472450889000022'),('3472650833000008'),('3453830876000007'),('3478750847000400')
,('3470350885000483'),('3447540896000320'),('3472360898001574'),('3452930836000039'),('3454730843000214'),('3447030883000301'),('3470350823000306')
,('3449840829000001'),('3451040886000029'),('3451240893000521'),('3457630823000001'),('3453730845000130'),('3451130879000555'),('3449930841000004')
,('3451130897000280'),('3453730871000087'),('3454030882000039'),('3457530830000293'),('3472460832000342'),('3454540834000036'),('3467460880000035')
,('3455330890000040'),('3447130837000215'),('3450240883000615'),('3472460826000217'),('3477940875000395'),('3467160896000520'),('3458140884000477')
,('3452130881000048'),('3458340847000164'),('3467940820000005'),('3457040835000504'),('3471850879000042'),('3448630841000001'),('3447640832000010')
,('3447830823000018'),('3455540897000567'),('3458140819000600'),('3472060833000018'),('3478260878000477'),('3472150881000620'),('3472750879000365')
,('3455140845000304'),('3455740848000761'),('3476260846000510'),('3457430840000005'),('3455740873000215'),('3451840891000587'),('3450340897000435')
,('3467250874000012'),('3450530888000002'),('3449140895000039'),('3457740891000666'),('3474940819000108'),('3456040825000085'),('3457440894000256')
,('3448440872000460'),('3449030869000489'),('3449030897000410'),('3470050888000502'),('3458030831000011'),('3473150893000427'),('3448240879000012')
,('3456340871000074'),('3449740872000207'),('3453630840000152'),('3468150835000201'),('3450240880000501'),('3457330875000419'),('3448830898000116')
,('3447930848000553'),('3448830876000518'),('3449240823000075'),('3454340875000015'),('3452930891000049'),('3454030841000021'),('3452440893000047')
,('3452630875000219'),('3470850828000367'),('3454830839000655'),('3472350871000511'),('3477850828000006'),('3472070889000432'),('3469750888000211')
,('3458630891000445'),('3454740834000297'),('3455530844000166'),('3458040873000308'),('3449830893000235'),('3455730827000338'),('3458040820000559')
INSERT #t values('3456930897000759'),('3450840834000059'),('3474940877000313'),('3474060894000053'),('3453130848000064'),('5049310881001742'),('3447720847000435')
,('3449600837000553'),('3493189736000125'),('3491089768000179'),('3497979739000296'),('3478750835000016'),('3453830889000184'),('3447730880000408')
,('3458730898001865'),('3451130885000052'),('3475750878000082'),('3449230897000044'),('3455330885000146'),('3458340880000410'),('3453140828000281')
,('3448240897000622'),('3475450898000101'),('3448930870000009'),('3449830885000086'),('3456830897000090'),('3473950872000003'),('3451040891000394')
,('3454430882000437'),('3456540846000212'),('3468350842000539'),('3477950832000024'),('3468450874000256'),('3454230818000240'),('3451030897000738')
,('3473850895000115'),('3452330848000004'),('3450840832000010'),('3449140840000050'),('3477350842000082'),('3453430825000289'),('3449930876000440')
,('3454330825000470'),('3451930843000478'),('3454830837000517'),('3452330869000016'),('3456930870000594'),('3468660895000115'),('3449530824000391')
,('3478940848000612'),('3470750889000175'),('3454340834000585'),('3450240879000553'),('3470560848000095'),('3467150844000300'),('3447130869000273')
,('3455730848000648'),('3454040894000000'),('3447730882000018'),('3473940843000315'),('3458030873000531'),('3452430835000551'),('3471850821000157')

INSERT #t values('3451440829000013'),('3458240841000386'),('3452730883000845'),('3452130889000008'),('3451240889000550'),('3447740829000039'),('3455740881000199')
,('3449230886000450'),('3447240841000034'),('3477050881000254'),('3474060872000273'),('3455330884000014'),('3456430877000036'),('3449130869000032'),('3449830875000054')
,('3452830834000686'),('3454930825000451'),('3458130835000098'),('3451540838000027'),('3474360885000173'),('3468760821000062'),('3452640875000028'),('3449730879000250')
,('3454340887000540'),('3472060883000025'),('3455830848000414'),('3458230847000373'),('3447040839000107'),('3455240895000897'),('3473250820000209'),('3472750822000108')
,('3473550870000029'),('3458330828000200'),('3452740821000062'),('3450530836000195'),('3454430898000397'),('3455430832000064'),('3454540898000088'),('3451530886000045')
,('3456030897000105'),('3452130890000138'),('3471350884000004'),('3458530847000103'),('3452330878000197'),('3468260846000262'),('3474150833000056'),('3449640881000059')
,('3475260888000171'),('3453740894000006'),('3448540886000115'),('3457440879000511'),('3457830824000378'),('3455630890000423'),('3456040875000589'),('3447230870000328')
,('3454540834000127'),('3469940886000400'),('3476060874000600'),('3471050887000627'),('3474450872000177'),('3453630895000024'),('3452640847000064'),('3454530896000099')

INSERT #t values('3455730889000226'),('3455740828000005'),('7773250873002217'),('3475660888000214'),('3469160848000725'),('3453040881000006'),('3450540843000070'),('3468250876000290')
,('3474550882000123'),('3456730881000025'),('3454130868000324'),('3478150884000464'),('3468960880000371'),('3457130897000011'),('3447540875000085'),('3451540877000292')
,('3448230839000285'),('3476360872000119'),('3453540898000006'),('3448040876000423'),('3458240898001998'),('3478050880000544'),('3456630892000040'),('3470460874000061')
,('3472260872000024'),('3450240832000013'),('3456930898000006'),('3447540881000046'),('3455930896000454'),('3451840846000476'),('3475950846000004'),('3469850887000020')
,('3468270870000062'),('3470360882000378'),('3458340887000041'),('3473160845000011'),('3469150895000587'),('3456240824000439'),('3454040843000606'),('3457430882000244')
,('3451330878000008'),('3458040848000144'),('3454440888000067'),('3455640891000603'),('3451730893000513'),('3448230891000389'),('3458330824000477'),('3467250878000299')
,('3471350825000444'),('3456730881000470'),('3477160873000046'),('3455840845000366'),('3458930827000133'),('3473650886000011'),('3474950883000033'),('3477050884000368')
,('3477360897000473'),('3449740879000564'),('3467050886000285'),('3474940885000479'),('3476860872000027'),('3473660881000015'),('3451040845000011'),('3472050819000017')
,('3451140871000016'),('3458230898000181'),('3458430890000045'),('3469350884000198'),('3447230870000112'),('3452140876000143'),('3452540890000203'),('3448040894000108')
INSERT #t values('3457440887000651'),('3447930888000018'),('3456330836000053'),('3448440880000304'),('3458040890000521'),('3449430884000011'),('3447430879000507')
,('3472650835000113'),('3450640842000426'),('3475450883000116'),('3451240868000019'),('3449140873000027'),('3455730896000052'),('3456840887000596'),('3470450891000335')
,('3471250843000378'),('3451830876000470'),('3451340869000560'),('3447240847000509'),('3458640876000518'),('3454340822000043'),('3457730892000039'),('3478940884000120')
,('3455030846000066'),('3458540845000062'),('3455140823000375'),('3454330885000436'),('3456330869000038'),('3467050898000208'),('3458240838000118'),('3447240875000363')
,('3457340892000581'),('3468150879000760'),('3452340886000527'),('3467060869000020'),('3452830890000026'),('3469450847000044'),('3451040893000137'),('3447630895000304')
,('3450840874000589'),('3451630840000519'),('3453230825000507'),('3449830885000680'),('3447530824000146'),('3450240870000479'),('3469050871000447'),('3450040895000094')
,('3451730819000043'),('3472360889000049'),('3467160819000300'),('3452040880000123'),('3454340842000098'),('3453030829000184'),('3457030878000529'),('3472160848000118')
,('3472260868000186'),('3476460884000568'),('3453730892000025'),('3458930874000069'),('3457140898000910'),('3455510838000711'),('3449400884000030'),('3497499729000099')
,('3447200876000028'),('3450200825000248'),('3450310872000395'),('3490499784000098'),('3492099783000368'),('3490199787000547'),('3456300877000015'),('3457410842000013')
INSERT #t values('3452210887000026'),('3448400895000012'),('3455010897000199'),('3456510897000668'),('3450610819000667'),('3448900873000017'),('3456500830000040')
,('3451700821000349'),('3454720818000034'),('3449420882000055'),('3447910832000066'),('3447520823000270'),('3455210890000812'),('3497199772000356'),('3493989774000154')
,('3452610828000219'),('3456410868000476'),('3448220894000015'),('3458999786000095'),('3447000835000006'),('3452010847000011'),('3448920844000045'),('3451900846000130')
,('3455610894000819'),('3489299771000041'),('3454310842000026'),('3449820818000238'),('3452200819000020'),('3451700833000253'),('3454400888000343'),('3487699731000241')
,('3458400872000222'),('3454600895000042'),('3448320896000417'),('3449620887000469'),('3452610876000590'),('3447110879000000'),('3454800892000033'),('3450520840000166')
,('3449610894000933'),('3455420887000598'),('3493099726000094'),('3493989792000384'),('3455800833000000'),('2354900820000825'),('3447610883000052'),('3457010842000524')
,('0596199786000497'),('3494989742000285'),('3490599733000154'),('3452100819000337'),('3450510877000601'),('3497699726000295'),('3448610883000036'),('3448310829000022')
,('3456510873000047'),('3450220843000574'),('3447210874000037'),('3456210879000519'),('3498699779000019'),('3456010818000053'),('3454300884000257'),('3456400834000205')
,('3454110826000038'),('3458110878000031'),('3451999722000131'),('3453120843000029'),('3453020841000288'),('3454720898000524'),('3496399781000014'),('3456300897000250')
,('3451900844000496'),('3450710882000832'),('3457700875000041'),('3450610879000029'),('3455810897000069'),('4756010893001427'),('3449420898000107'),('3448810828000121')
,('3491599786000134'),('3456110836000430'),('3493989732000023'),('3453310819000075'),('3458510880000095'),('3449800821000367'),('3448820833000313'),('3447610820000504')
INSERT #t values('3449100887000363'),('3447520842000368'),('3496799781000106'),('3488799747000059'),('3455210890000630'),('3448210889000062'),('3453900841000240')
,('3498099780000019'),('3447210887000024'),('3454500888000068'),('3458300871000035'),('3450800882000252'),('3448310824000068'),('3456420823000008'),('3447600882000302')
,('3452120873000684'),('3455720878000055'),('3493799744000071'),('3454200835000051'),('3447720881000002'),('3454710879000015'),('3452510821000069'),('3454900889000101')
,('3458200896000228'),('3458920890000375'),('3497099778000063'),('3490099730000315'),('3449720891000016'),('3448510846000000'),('3456620868000025'),('3448120831000450')
,('3487199742000181'),('3453420824000455'),('3497599724000273'),('3496299777000327'),('3453020829000037'),('3449900879000044'),('3453000883000065'),('3455110825000392')
,('3455420892000468'),('3454010832000032'),('3491989747000218'),('3449810829000582'),('3496699784000006'),('3454110833000047'),('3457000896000041'),('3455200894000207')
,('3449210818000596'),('3451310875000078'),('3450610891000056'),('3451520831000018'),('3453120880000064'),('3453010870000556'),('3451510888000813'),('3454220881000706')
,('3449910882000006'),('3496499785000174'),('3491399744000254'),('3455900826000023'),('3454620843000233'),('3449020839000289'),('3452510845000012'),('3449020868000648')
,('3487299739000044'),('3493199744000256'),('3449020825000079'),('3448100869000028'),('3453300821000031'),('3452510898000042'),('3458500885000075'),('3457700898000044')
,('3449010843000110'),('3492499729000193'),('3450510873000530'),('3452410818000661'),('3450510893000098'),('3450900832000434'),('3457400832000438'),('3453110822000702')
,('3498099787000079'),('3498989771000483'),('3447700890000029'),('3492699775000100'),('3494699768000081'),('3453320879000212'),('3453000847000276'),('3453900898000044')
,('3455510840000048'),('3458100837000263'),('3457310834000528'),('3491099736000078'),('3454500871000042'),('3487399789000041'),('3455400822000069'),('3453710890000672')
,('3489299731000164'),('3449220826000447'),('3455120838000677'),('3454410824000703'),('3447410848000069'),('3454600819000045'),('3456220889000011'),('3496799742000286')
INSERT #t values('3495099742000043'),('3454320888000020'),('3451720883000052'),('3450920847000351'),('3454310897000079'),('3448420841000049'),('3453520885000664'),('3450110876000718'),('3493299793000239'),('3452800881000632'),('2052210825000290'),('3447310837000080'),('3497599724000562'),('3455120826000440'),('3497199783000320'),('3451000894000171'),('3452820894000445'),('3447600821000371'),('3488399734000251'),('3494299795000160'),('3450920873000010'),('3458920828000018'),('3453220872000260'),('3451510880000365'),('3487099745000461'),('3450110885000006'),('3457700841000018'),('3449200888000253'),('3451120840000453'),('3453010824000074'),('3450510896000020'),('3454999779000189'),('3447010871000489'),('3451510888000961'),('3450310898000866'),('3451510845000039'),('3456010872000056'),('3451810885000000'),('3496889744000200'),('3449120839000006'),('3490599743000418'),('3448410895000086'),('3458100844000322'),('3496889748000255'),('3451310843000028'),('3493699778000122'),('3454210886000637'),('3456720887000012'),('3450010875000083'),('3456810895000060'),('3454020874000303'),('3451810892000365'),('3451810828000364'),('3448410895000540'),('3456800894000500'),('3449620836000305'),('3452610833000022'),('3457310832000074'),('3458220840000157'),('3458410891000582'),('3447220873000672'),('3456910840000015'),('3497199774000321'),('3458010835000134'),('3494599780000186'),('3497499796000113'),('3456700874000464'),('3458300837000004'),('3448520875000078'),('3456810888000440'),('3449000818000112'),('3454920896000449'),('3458800824000545'),('3491989772000034'),('3458510825000069'),('3448600843000002'),('3458700825000082'),('3496899785000316'),('3453700846000066'),('3453610831000031'),('3496699744000286'),('3491299736000256'),('3448100836000077'),('3454410898000324'),('3450510877000460'),('3453810882000126'),('3449210832000366'),('3449010898000247'),('3458410826000350'),('3487199769000346'),('3449910882000022'),('3497989722000161'),('3452610819000061'),('3457510885000042'),('3451110834000379'),('3458610842000090'),('3456620877000537'),('3453200896000017'),('3488899769000027'),('3453500843000360'),('3449010845000118'),('3458410828000077'),('3492899776000329'),('3456410895000754'),('3453220830000428'),('3455610826000010'),('3451910847000005'),('3449600821000007'),('3450010879000006'),('3451110830000456'),('3451120880000579'),('3455200843000084'),('3448900848000068'),('3453510830000091'),('3452900847000062'),('3453720835000109'),('3447700870000122'),('3453700891000250'),('3449010845000167'),('3456310880000555'),('3456410822000406'),('3458320872000701'),('3449710893000759'),('3457700883000157'),('3494599719000224'),('3456999780000184'),('3454210838000032'),('3451700868000087'),('3455610890000714'),('3451210820000035'),('3449210884000405'),('3451300882000278'),('3451710883000012'),('3451800885000340'),('3491899798000001'),('3447000846000011'),('3451310841000103'),('3447210836000059'),('3452500895000046'),('3450210832000073'),('3453420886000005'),('3447210836000521'),('3490199747000116'),('3455500820000043'),('3454510838000050'),('3453420880000084'),('3451700829000341'),('3494599741000267'),('3457010827000531'),('3451820874000507'),('3453720885000009'),('3452100822000035'),('3452610841000030'),('3454500820000044'),('3451800882000384'),('3450420887000296'),('3450999736000128'),('3447100843000210'),('3457700826000041'),('3456010824000014'),('3453000840000216'),('3451110821000549'),('3448810898000761'),('3451900894000495'),('3496799784000111'),('3453800883000415'),('3493899728000343'),('3458500823000435'),('3452610828000060'),('3453510871000158'),('3488499727000332'),('3449520831000278'),('3456600831000047'),('3449999720000112'),('3450400886000208'),('3487599797000194'),('3449410820000028'),('3458510868000349'),('3447320885000098'),('3457710835000098'),('3447820884000429'),('3454820832000109'),('3448010879000407'),('3458410846000042'),('3454000848000043'),('3450010869000032'),('3452810873000037'),('3452420898000044'),('3458420848000098'),('3450610879000383'),('3498599769000203'),('3447120824000328'),('3454210879000982'),('3497889747000362'),('3489799729000019'),('3496299788000043'),('3454600895000034'),('3457810874000023'),('3450120828000088'),('3498699746000191'),('3447410890000561'),('3453810845000478'),('3449600887000438'),('3449320837000509'),('3492399742000495'),('3452220843000002'),('3490499744000162'),('3451320829000488'),('3490699790000277'),('3454700829000538'),('3449310869000071'),('3455420832000008'),('3450410888000023'),('3456310821000086'),('3447810819000099'),('3494199725000209'),('3456900883000055'),('3455310843000727'),('3497599786000146'),('3450210825000536'),('3453710844000539'),('3449410835000666'),('3455400882000033'),('3447810830000227'),('3447300838000254'),('3455520848000569'),('3487199774000075'),('3489989725000242'),('3456610821000626'),('3456900876000070'),('3488599796000087'),('3452999729000372'),('3457320885000046'),('3453710838000388'),('3447500844000269'),('3495599719000504'),('3456100870000016'),('3498999730000011'),('3447300822000005'),('3488799792000301'),('3456400834000288'),('3449120838000296'),('3449410896000621'),('3497299736000326'),('3496989796000163'),('3451300884000029'),('3450400895000009'),('3448200833000029'),('3449999784000024'),('3458510836000645'),('3490699778000331'),('3455610844000471'),('3491299745000180'),('3494199769000370'),('3451110841000057'),('3450610822000035'),('3450510879000021'),('3447700896000403'),('3458810873000726'),('3456820844000483'),('3490199728000267'),('3456700891000380'),('3448700881000425'),('3497199783000015'),('3491099730000009'),('3492899723000000'),('3451500886000022'),('3487899742000095'),('3487599779000105'),('3448800837000394'),('3455900880000075'),('3454820896000052'),('3454900898000209'),('3453920845000434'),('3494099787000230'),('3455210883000175'),('3453500892000311'),('3453210897000056'),('3452710886000158'),('3492989797000422'),('3451110877000633'),('3455500827000434'),('3449620894000460'),('3487299781000082'),('3496199780000233'),('3447400823000051'),('3453200823000353'),('3455410826000064'),('3453310873000078'),('3448810881000042'),('3453710819000068'),('3498099771000317'),('3448810876000007'),('3458200825000026'),('3498899790000036'),('3448710877000347'),('3454400868000404'),('3457700848000458'),('3453400880000037'),('3454300840000201'),('3448420842000469'),('3497989740000367'),('3452800844000489'),('3450600841000371'),('3453010840000066'),('3450110895000111'),('3448720837000063'),('3447920826000089'),('3496899788000172'),('3452100871000399'),('3497989733000572'),('3458000837000018'),('3455600822000395'),('3490799773000417'),('3447920870000001'),('3458820879000067'),('3453320898000326'),('3487799772000348'),('3487199733000349'),('3498889788000429'),('7052900841000261'),('7053800831000231'),('7053800831000215'),('3452020836000617'),('3447810822000532'),('3455330823000323'),('3457010825000608'),('6458310876000073'),('3455710829000650'),('3494889730000281'),('3491889795000070'),('3455320838000616'),('3487989788000289'),('3451630887000497'),('3448710895000980'),('3491889725000398'),('3449910889000686'),('3448630897000624'),('3447610833000699'),('3449820872000561'),('3457920885000449'),('3489889743000267'),('3453820832000522'),('3454800885000610'),('3456420838000589'),('3487889737000069'),('3449930820000611'),('3454810879000997'),('3458320827000608'),('3447220848000690'),('3455730843000601'),('3449620846000303'),('3457410839000778'),('3457710826000727'),('3453440887000713'),('3450540828000509'),('3448320827000809'),('3447910840000603'),('3448230882000513'),('3452240896000659'),('3451420848000558'),('3447810848000623'),('3454810870000871'),('2354220886000936'),('3458440847001319'),('7752420887001373'),('3458240827000616'),('1152230833000257'),('3455320824000612'),('3455730870000698'),('3453930824000511'),('3447520889000610'),('3451310835000689'),('3456540841000753'),('3450710846000662'),('3356010892000293'),('7849210836003611'),('3451730890000706'),('3447040827000598'),('3453820830000441'),('3458910836000449'),('3457610879000956'),('4852630820000011'),('3448030828000423'),('3457030891000464'),('5055710826001619'),('3471150846000641'),('3455210835000836'),('3448430839000513'),('3448040882000615'),('3451520818000510'),('3450440819000818'),('3456520819000498'),('3455320841000694'),('3468940822000374'),('3469360841000397'),('3451010835000677'),('3449510835000689'),('3450420843000554'),('3455340848001008'),('3452220824000658'),('3455840848000843'),('3450910821000808'),('3456220819000560'),('3452720847000544'),('3455320886000831'),('3456330839000514'),('7847520880001952'),('3450230840000493'),('3487989730000221'),('3457340838000471'),('3496789732000164'),('3495789737000145'),('3447710885001130'),('3495789735000188'),('3494789744000246'),('6477070833043486'),('3458130837000377'),('3492789788000039'),('3491789797000419'),('3496789722000463'),('3489789779000084'),('3455720876000495'),('3452810876000984'),('3488789719000062'),('3487199742000223'),('3487799741000379'),('3489499792000489'),('3498689791000253'),('3497689793000179'),('3489099773000407'),('3447710828000827'),('3497689737000491'),('3487889733000378'),('3456340881000569'),('3495689780000044'),('3454440843000483'),('3449830882000675'),('3470160873000779'),('3496689719000304'),('3447120822000502'),('3247410872000177'),('3492689747000189'),('3493689734000340'),('3494689719000454'),('2751130896000207'),('3455120841000607'),('3491689796000024'),('3495689745000410'),('3492689776000332'),('0554900888000230'),('3454430877000699'),('7856510894002664'),('3490689730000107'),('3491689726000540'),('3490689783000350'),('3450220836000565'),('3488689738000350'),('3487689737000279'),('2049240887000173'),('0558710826000432'),('6468940892020453'),('3458540818000537'),('3496589728000172'),('3453710841000755'),('2351120831000812'),('3495589797000351'),('3494589734000325'),('3493589721000263'),('3493589719000218'),('3448330847000598'),('3454020842000575'),('3451040832000784'),('3491589794000341'),('3491589797000215'),('3455400826000370'),('3489589746000260'),('3457810829000565'),('3487589740000201'),('3447820825000686'),('3456620890000464'),('3491689734000482'),('3448030832000369'),('3447400889000250'),('3488589789000384'),('3498489745000305'),('3497989724000532'),('3453230869000462'),('3452110881000867'),('3496489787000264'),('4793889723000484'),('3496489733000269'),('3496489773000252'),('3495489729000084'),('3457720842000593'),('4548010874000151'),('4598589742000153'),('4588199780000172'),('4588099747000143'),('3496489721000354'),('5997199771000514'),('5995989731000444'),('3492489769000013'),('5256540822002106'),('3492489772000455'),('3491489788000342'),('8349220836000130'),('3490489784000479'),('3491489728000584'),('6196689734000384'),('3498389722000114'),('3487489744000226'),('3498599769000039'),('3494389746000029'),('3449140876000677'),('3492389773000233'),('3491389723000144'),('3492389721000475'),('3448730896000516'),('7853020833004311'),('3447020831000594'),('7589499718000225'),('7547510885000169'),('7595099773000227'),('3487389720000424'),('3497289738000051'),('3447240888000558'),('3391889777000198'),('3395389786000152'),('3496289745000103'),('5952510889000480'),('5653810839000040'),('2652330841000449'),('3491289740000095'),('3478150837000389'),('3447840830000372'),('3489289732000404'),('3498189745000020'),('3454720842000679'),('3497189791000230'),('3498189779000227'),('0554400848000537'),('3497189774000124'),('3494189739000071'),('3498189775000353'),('3493189770000080'),('3492189789000056'),('3494189785000280'),('3448830871000562'),('3495089741000284'),('3449030889000626'),('6450040821080510'),('2355440834000569'),
('3489089795000337'),('3488089787000254'),('3498979741000010'),('3497979727000159'),
('3496979736000233'),('3487979790000237'),('0550920875000450'),('0556430832000779'),('3450030822000382')

DECLARE @dateStartReg DATETIME='20200101',
		@dateEndReg DATETIME=GETDATE(),
		@dateStartRegRAK DATETIME='20210101',
		@dateEndRegRAK DATETIME=GETDATE()

SELECT DISTINCT c.id AS rf_idCase, c.AmountPayment,f.CodeM,p.ENP,c.AmountPayment AS AmPay, dd.DS1
INTO #tCases
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts
					INNER JOIN dbo.t_PatientSMO p ON
            r.id=p.rf_idRecordCasePatient			
					JOIN #t t ON
            p.ENP=t.ENP
					INNER JOIN dbo.t_Case c ON
			r.id=c.rf_idRecordCasePatient			
					INNER JOIN dbo.vw_Diagnosis dd ON
			c.id=dd.rf_idCase						
WHERE f.DateRegistration>=@dateStartReg AND f.DateRegistration<@dateEndReg  AND f.TypeFile='H' AND a.ReportYearMonth>=202001 AND a.ReportYearMonth<202103

UPDATE p SET p.AmountPayment=p.AmountPayment-r.AmountDeduction
FROM #tCases p INNER JOIN (SELECT c.rf_idCase,SUM(c.AmountDeduction) AS AmountDeduction
								FROM dbo.t_PaymentAcceptedCase2 c
								WHERE c.DateRegistration>=@dateStartRegRAK AND c.DateRegistration<@dateEndRegRAK AND c.TypeCheckup=1
								GROUP BY c.rf_idCase
							) r ON
			p.rf_idCase=r.rf_idCase

DELETE FROM #tCases WHERE (CASE WHEN AmPay>0 AND AmountPayment=0.0 THEN 1 WHEN AmPay=0 AND AmountPayment<0.0 THEN 1 ELSE 0 END)=1

SELECT code,name AS CSG INTO #tCSG FROM dbo.vw_sprCSG WHERE dateBeg>='20200101'
UNION ALL
SELECT DISTINCT MU,MUName FROM vw_sprMUCompletedCase


SELECT DISTINCT r.AttachLPU,l.NAMES AS MO_Attach,f.CodeM+' - '+ll.NAMES AS LPU,a.Account,a.DateRegister AS DateAccount,cc.idRecordCase,c.ENP
,p.Fam+ ' '+ISNULL(p.im,'')+' '+ISNULL(p.ot,'') AS FIO, p.BirthDay, cc.NumberHistoryCase,v6.name AS V006
,c.DS1+' - '+mkb.Diagnosis AS DS1,v2.name AS PROFIL,v14.NAME AS FOR_POM
,CASE WHEN cc.rf_idV006<3 THEN c1.DateBegin ELSE NULL END AS DateBeg,CASE WHEN cc.rf_idV006<3 THEN c1.DateEnd ELSE NULL END AS DateEnd
,v25.N_PC AS P_CEL, v21.name AS PRVS
,mes.MES, sm.CSG,m.MU,mu.MUName
INTO #tTotal
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts
					JOIN dbo.vw_sprT001 l ON
            r.AttachLPU=l.CodeM
					JOIN dbo.vw_sprT001 ll ON
            f.CodeM=ll.CodeM
					INNER JOIN dbo.t_PatientSMO ps ON
            r.id=ps.rf_idRecordCasePatient
					INNER JOIN dbo.t_Case cc ON
			r.id=cc.rf_idRecordCasePatient
					JOIN dbo.t_CompletedCase c1 ON
			r.id=cc.rf_idRecordCasePatient
					INNER join #tCases c ON
			cc.id=c.rf_idCase          
					JOIN dbo.vw_sprV002 v2 ON
            cc.rf_idV002=v2.id
					JOIN dbo.vw_sprMKB10 mkb ON
            c.DS1=mkb.DiagnosisCode
					JOIN RegisterCases.dbo.vw_sprV006 v6 ON
             cc.rf_idV006=v6.id
					JOIN oms_nsi.dbo.sprV014 v14 ON
             cc.rf_idV014=v14.IDFRMMP
					INNER JOIN dbo.t_RegisterPatient p ON
			r.id=p.rf_idRecordCase
					JOIN dbo.vw_sprV004 v21 ON
            cc.rf_idV004=v21.id   					
					JOIN dbo.t_MES mes ON
			cc.id=mes.rf_idCase
					JOIN #tCSG sM ON
            mes.MES=sM.code
					LEFT JOIN t_PurposeOfVisit pv ON
            cc.id=pv.rf_idCase
					LEFT JOIN oms_nsi.dbo.sprV025 v25 ON
            pv.rf_idV025=v25.IDPC					 
					LEFT JOIN dbo.t_Meduslugi m ON
            cc.id=m.rf_idCase
			AND m.Price>0
					LEFT JOIN dbo.vw_sprMU  mu ON
            m.MU=mu.MU
WHERE f.DateRegistration>=@dateStartReg AND f.DateRegistration<@dateEndReg  AND f.TypeFile='H' AND a.ReportYearMonth>=202001 AND a.ReportYearMonth<202103

--ALTER TABLE #tTotal ADD MU VARCHAR(14)
--ALTER TABLE #tTotal ADD MU VARCHAR(250)

SELECT DISTINCT r.AttachLPU,l.NAMES AS MO_Attach,f.CodeM+' - '+ll.NAMES AS LPU,a.Account,a.DateRegister AS DateAccount,cc.idRecordCase,c.ENP
,p.Fam+ ' '+ISNULL(p.im,'')+' '+ISNULL(p.ot,'') AS FIO, p.BirthDay, cc.NumberHistoryCase,v6.name AS V006
,c.DS1+' - '+mkb.Diagnosis AS DS1,v2.name AS PROFIL,v14.NAME AS FOR_POM
,CASE WHEN cc.rf_idV006<3 THEN c1.DateBegin ELSE NULL END AS DateBeg,CASE WHEN cc.rf_idV006<3 THEN c1.DateEnd ELSE NULL END AS DateEnd
,v25.N_PC AS P_CEL, v21.name AS PRVS
,NULL,null,m.MU,mu.MUName
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts
					JOIN dbo.vw_sprT001 l ON
            r.AttachLPU=l.CodeM
					JOIN dbo.vw_sprT001 ll ON
            f.CodeM=ll.CodeM
					INNER JOIN dbo.t_PatientSMO ps ON
            r.id=ps.rf_idRecordCasePatient
					INNER JOIN dbo.t_Case cc ON
			r.id=cc.rf_idRecordCasePatient
					JOIN dbo.t_CompletedCase c1 ON
			r.id=cc.rf_idRecordCasePatient
					INNER join #tCases c ON
			cc.id=c.rf_idCase          
					JOIN dbo.vw_sprV002 v2 ON
            cc.rf_idV002=v2.id
					JOIN dbo.vw_sprMKB10 mkb ON
            c.DS1=mkb.DiagnosisCode
					JOIN RegisterCases.dbo.vw_sprV006 v6 ON
             cc.rf_idV006=v6.id
					JOIN oms_nsi.dbo.sprV014 v14 ON
             cc.rf_idV014=v14.IDFRMMP
					INNER JOIN dbo.t_RegisterPatient p ON
			r.id=p.rf_idRecordCase
					JOIN dbo.vw_sprV004 v21 ON
            cc.rf_idV004=v21.id   										
					LEFT JOIN t_PurposeOfVisit pv ON
            cc.id=pv.rf_idCase
					LEFT JOIN oms_nsi.dbo.sprV025 v25 ON
            pv.rf_idV025=v25.IDPC					 
					JOIN dbo.t_Meduslugi m ON
			cc.id=m.rf_idCase
			AND m.Price>0
					LEFT JOIN dbo.vw_sprMU  mu ON
            m.MU=mu.MU
WHERE f.DateRegistration>=@dateStartReg AND f.DateRegistration<@dateEndReg  AND f.TypeFile='H' AND a.ReportYearMonth>=202001 AND a.ReportYearMonth<202103
AND NOT EXISTS(SELECT * FROM t_Mes mes WHERE m.rf_idCase=cc.id)

GO
DROP TABLE #t
GO
DROP TABLE #tCases
GO
DROP TABLE #tTotal
GO
DROP TABLE #tCSG