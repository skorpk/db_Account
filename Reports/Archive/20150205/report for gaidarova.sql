USE AccountOMS--Reports
GO		
DECLARE @letter CHAR(1)	='D',
		@dtStart DATETIME='20140101',
		@dtEnd DATETIME='20150203 23:59:59',
		@reportYear SMALLINT=2014,
		@dtRPDEnd datetime=GETDATE()

DECLARE @lpu AS TABLE(CodeM CHAR(6),Letter CHAR(1))

INSERT @lpu( CodeM,Letter )
SELECT v.CodeM,'O'
FROM (VALUES  ('101003'),	('114504'),('114506'),('121018'),('124528'),('124530'),('134505'),('134510'),('141016'),('141022'),('141023'),('141024'),('154602'),('154608'),
		('154620'),('161007'),('161015'),('174601'),('175709'),('184512'),('184603'),('251001'),('251002'),('251003'),('254504'),('254505'),('255802'),('301001'),
		('311001'),('321001'),('331001'),('341001'),('351001'),('361001'),('371001'),('381001'),('391001'),('391002'),('401001'),('411001'),('421001'),('431001'),
		('441001'),('451001'),('461001'),('471001'),('481001'),('491001'),('501001'),('511001'),('521001'),('531001'),('541001'),('551001'),('561001'),('571001'),
		('581001'),('591001'),('601001'),('611001'),('621001'),('711001')) v(CodeM)
INSERT @lpu
        ( CodeM, Letter )
VALUES  ('101003','R'),('114504','R'),
('114506','R'),('121018','R'),('124528','R'),('124530','R'),('134505','R'),('134510','R'),('141016','R'),('141022','R'),('141023','R'),('141024','R'),
('154602','R'),('154608','R'),('154620','R'),('161007','R'),('161015','R'),('174601','R'),('175709','R'),('184512','R'),('184603','R'),('251001','R'),
('251002','R'),('251003','R'),('254504','R'),('254505','R'),('255802','R'),('301001','R'),('311001','R'),('321001','R'),('331001','R'),('341001','R'),
('351001','R'),('361001','R'),('371001','R'),('381001','R'),('391001','R'),('391002','R'),('401001','R'),('411001','R'),('421001','R'),('431001','R'),
('441001','R'),('451001','R'),('461001','R'),('471001','R'),('481001','R'),('491001','R'),('501001','R'),('511001','R'),('521001','R'),('531001','R'),
('541001','R'),('551001','R'),('561001','R'),('571001','R'),('581001','R'),('591001','R'),('601001','R'),('611001','R'),('621001','R'),('711001','R'),
('115506','D'),('121018','D'),('124530','D'),('125505','D'),('131020','D'),('135509','D'),('145516','D'),('145526','D'),('155601','D'),('165525','D'),
('185515','D'),('251008','D'),('255601','D'),('255627','D'),('361001','D'),('391003','D'),('431001','D'),('451002','D'),('481001','D'),('531001','D'),
('541001','D'),('591001','D'),('601001','D'),('611001','D'),('621001','D'),('115506','U'),('115510','U'),('121018','U'),('124528','U'),('124530','U'),
('125505','U'),('131020','U'),('135509','U'),('145516','U'),('145526','U'),('155502','U'),('155601','U'),('165525','U'),('165531','U'),('175603','U'),('175617','U'),
('175627','U'),('185515','U'),('251008','U'),('255601','U'),('255627','U'),('301001','U'),('311001','U'),('321001','U'),('331001','U'),('341001','U'),('351001','U'),
('361001','U'),('371001','U'),('381001','U'),('391003','U'),('401001','U'),('411001','U'),('421001','U'),('431001','U'),('441001','U'),('451002','U'),('461001','U'),
('471001','U'),('481001','U'),('491001','U'),('501001','U'),('511001','U'),('521001','U'),('531001','U'),('541001','U'),('551001','U'),('561001','U'),('571001','U'),
('581001','U'),('591001','U'),('601001','U'),('611001','U'),('621001','U'),('115506','F'),('115510','F'),('121018','F'),('124528','F'),('124530','F'),
('125505','F'),('131020','F'),('135509','F'),('145516','F'),('145526','F'),('155502','F'),('155601','F'),('165525','F'),('165531','F'),('175603','F'),
('175617','F'),('175627','F'),('185515','F'),('251008','F'),('254506','F'),('255601','F'),('255627','F'),('301001','F'),('311001','F'),('321001','F'),
('331001','F'),('341001','F'),('351001','F'),('361001','F'),('371001','F'),('381001','F'),('391003','F'),('401001','F'),('411001','F'),('421001','F'),
('431001','F'),('441001','F'),('451002','F'),('461001','F'),('471001','F'),('481001','F'),('491001','F'),('501001','F'),('511001','F'),('521001','F'),
('531001','F'),('541001','F'),('551001','F'),('561001','F'),('571001','F'),('581001','F'),('591001','F'),('601001','F'),('611001','F'),('621001','F')
,('115506','V'),('115510','V'),('121018','V'),('124528','V'),('124530','V'),
('125505','V'),('131020','V'),('135509','V'),('145516','V'),('145526','V'),('155502','V'),('155601','V'),('165525','V'),('165531','V'),('175603','V'),
('175617','V'),('175627','V'),('185515','V'),('251008','V'),('254506','V'),('255601','V'),('255627','V'),('301001','V'),('311001','V'),('321001','V'),
('331001','V'),('341001','V'),('351001','V'),('361001','V'),('371001','V'),('381001','V'),('391003','V'),('401001','V'),('411001','V'),('421001','V'),
('431001','V'),('441001','V'),('451002','V'),('461001','V'),('471001','V'),('481001','V'),('491001','V'),('501001','V'),('511001','V'),('521001','V'),
('531001','V'),('541001','V'),('551001','V'),('561001','V'),('571001','V'),('581001','V'),('591001','V'),('601001','V'),('611001','V'),('621001','V')
,('115506','I'),('115510','I'),('121018','I'),('124528','I'),('124530','I'),
('125505','I'),('131020','I'),('135509','I'),('145516','I'),('145526','I'),('155502','I'),('155601','I'),('165525','I'),('165531','I'),('175603','I'),
('175617','I'),('175627','I'),('185515','I'),('251008','I'),('254506','I'),('255601','I'),('255627','I'),('301001','I'),('311001','I'),('321001','I'),
('331001','I'),('341001','I'),('351001','I'),('361001','I'),('371001','I'),('381001','I'),('391003','I'),('401001','I'),('411001','I'),('421001','I'),
('431001','I'),('441001','I'),('451002','I'),('461001','I'),('471001','I'),('481001','I'),('491001','I'),('501001','I'),('511001','I'),('521001','I'),
('531001','I'),('541001','I'),('551001','I'),('561001','I'),('571001','I'),('581001','I'),('591001','I'),('601001','I'),('611001','I'),('621001','I')
		
CREATE TABLE #tPeople(rf_idCase BIGINT,					  
					  CodeM CHAR(6),
					  Quantity DECIMAL(6,2),
					  AmountPayment DECIMAL(11,2), 
					  AmountRAK DECIMAL(11,2),
					  )
INSERT #tPeople (rf_idCase,CodeM,Quantity,AmountPayment)
SELECT c.id,f.CodeM,SUM(m.Quantity),c.AmountPayment
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles
			AND a.Letter=@letter
					INNER JOIN @lpu l ON
			f.CodeM=l.CodeM
			AND l.Letter=@letter
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts
					INNER JOIN dbo.t_Case c ON
			r.id=c.rf_idRecordCasePatient	
			AND c.DateEnd>'20131231' AND c.DateEnd<'20150101'
					INNER JOIN dbo.t_Meduslugi m ON
			c.id=m.rf_idCase					
WHERE f.DateRegistration>@dtStart AND f.DateRegistration<@dtEnd AND a.ReportYear=@reportYear AND m.MU LIKE '2.3.%'--m.MUGroupCode=2 AND MUUnGroupCode=3
GROUP BY  c.id,f.CodeM,c.AmountPayment
--------------------------------------Update information about RAK---------------------------
UPDATE p SET p.AmountRAK=p.AmountPayment-r.AmountDeduction
FROM #tPeople p INNER JOIN (SELECT rf_idCase,SUM(AmountDeduction) AS AmountDeduction 
							FROM [SRVSQL1-ST2].AccountOMSReports.dbo.t_PaymentAcceptedCase a INNER JOIN @lpu l ON
										a.CodeM=l.CodeM
										AND l.Letter=@letter 
							WHERE DateRegistration>=@dtStart AND DateRegistration<@dtRPDEnd AND a.Letter=@letter	
							GROUP BY rf_idCase
							) r ON
			p.rf_idCase=r.rf_idCase

SELECT l.CodeM,l.NAMES,COUNT(p.rf_idCase) AS Col3, CAST(SUM(p.Quantity) AS MONEY) AS Col4
FROM #tPeople p INNER JOIN dbo.vw_sprT001 l ON
		p.CodeM=l.CodeM
WHERE p.AmountRAK>0		
GROUP BY l.CodeM,l.NAMES			
ORDER BY l.CodeM
go

DROP TABLE #tPeople


