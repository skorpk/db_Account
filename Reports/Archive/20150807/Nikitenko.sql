USE AccountOMS
GO
DECLARE @t AS TABLE(id TINYINT,rf_idCase bigint, Account VARCHAR(15),NumberCase BIGINT,CodeM CHAR(6),AmountPayment DECIMAL(11,2),AmountRAK DECIMAL(11,2), AmountRPD DECIMAL(11,2),Policy VARCHAR(20))

INSERT @t
        ( id, Account, NumberCase, CodeM )
VALUES  (1,'34001-20-1O',1,'301001'),(2,'34001-35-1O',7,'301001'),(3,'34001-51-1O',2,'301001'),(4,'34002-10-1O',1,'301001'),(5,'34002-10-1O',2,'301001'),(6,'34002-10-1O',7,'301001'),(7,'34002-10-1O',11,'301001'),(8,'34002-10-1O',15,'301001'),
		(9,'34002-10-1O',17,'301001'),(10,'34002-10-1O',19,'301001'),(11,'34002-10-1O',20,'301001'),(12,'34002-10-1O',21,'301001'),(13,'34002-10-1O',24,'301001'),(14,'34002-10-2O',1,'301001'),(15,'34002-19-1O',43,'301001'),
		(16,'34002-20-1O',28,'301001'),(17,'34002-20-1O',65,'301001'),(18,'34002-20-1O',75,'301001'),(19,'34002-20-1O',94,'301001'),(20,'34002-20-1O',109,'301001'),(21,'34002-20-1O',110,'301001'),(22,'34002-20-1O',111,'301001'),
		(23,'34002-20-1O',10,'301001'),(24,'34002-20-1O',45,'301001'),(25,'34002-20-1O',47,'301001'),(26,'34002-20-1O',56,'301001'),(27,'34002-20-1O',90,'301001'),(28,'34002-20-1O',100,'301001'),(29,'34002-20-1O',113,'301001'),
		(30,'34002-24-1O',1,'301001'),(31,'34002-24-1O',2,'301001'),(32,'34002-24-1O',5,'301001'),(33,'34002-24-1O',6,'301001'),(34,'34002-24-1O',8,'301001'),(35,'34002-24-1O',9,'301001'),(36,'34002-24-1O',11,'301001'),
		(37,'34002-24-1O',12,'301001'),(38,'34002-24-1O',13,'301001'),(39,'34002-24-1O',18,'301001'),(40,'34002-24-1O',19,'301001'),(41,'34002-24-1O',21,'301001'),(42,'34002-24-1O',23,'301001'),(43,'34002-24-1O',24,'301001'),
		(44,'34002-24-1O',29,'301001'),(45,'34002-24-1O',31,'301001'),(46,'34002-24-1O',32,'301001'),(47,'34002-24-1O',35,'301001'),(48,'34002-24-1O',40,'301001'),(49,'34002-24-1O',42,'301001'),(50,'34002-24-1O',47,'301001'),
		(51,'34002-24-1O',48,'301001'),(52,'34002-24-1O',52,'301001'),(53,'34002-24-1O',54,'301001'),(54,'34002-24-1O',57,'301001'),(55,'34002-24-1O',60,'301001'),(56,'34002-24-1O',63,'301001'),(57,'34002-24-1O',64,'301001'),
		(58,'34002-24-1O',65,'301001'),(59,'34002-24-1O',66,'301001'),(60,'34002-24-1O',67,'301001'),(61,'34002-24-1O',69,'301001'),(62,'34002-24-1O',70,'301001'),(63,'34002-24-1O',71,'301001'),(64,'34002-24-1O',73,'301001'),
		(65,'34002-24-1O',7,'301001'),(66,'34002-24-1O',14,'301001'),(67,'34002-24-1O',16,'301001'),(68,'34002-24-1O',27,'301001'),(69,'34002-24-1O',30,'301001'),(70,'34002-24-1O',36,'301001'),(71,'34002-24-1O',41,'301001'),
		(72,'34002-24-1O',43,'301001'),(73,'34002-24-1O',46,'301001'),(74,'34002-24-1O',49,'301001'),(75,'34002-24-1O',51,'301001'),(76,'34002-24-1O',53,'301001'),(77,'34002-24-1O',58,'301001'),(78,'34002-24-1O',59,'301001'),
		(79,'34002-24-1O',68,'301001'),(80,'34002-24-1O',72,'301001'),(81,'34002-35-1O',8,'301001'),(82,'34002-35-1O',13,'301001'),(83,'34002-35-1O',44,'301001'),(84,'34002-35-1O',87,'301001'),(85,'34002-35-1O',87,'301001'),
		(86,'34002-35-1O',92,'301001'),(87,'34002-35-1O',148,'301001'),(88,'34002-35-1O',192,'301001'),(89,'34002-35-1O',194,'301001'),(90,'34002-35-1O',196,'301001'),(91,'34002-35-1O',3,'301001'),(92,'34002-35-1O',112,'301001'),
		(93,'34002-35-1O',225,'301001'),(94,'34002-35-1O',234,'301001'),(95,'34002-37-1O',1,'301001'),(96,'34002-37-1O',3,'301001'),(97,'34002-37-1O',15,'301001'),(98,'34002-37-1O',18,'301001'),(99,'34002-37-1O',28,'301001'),
		(100,'34002-37-1O',10,'301001'),(101,'34002-45-1O',1,'301001'),(102,'34002-45-1O',2,'301001'),(103,'34002-45-1O',5,'301001'),(104,'34002-51-1O',12,'301001')




UPDATE v SET v.rf_idCase=c.id, v.Policy=ISNULL(r.SeriaPolis,'')+r.NumberPolis, v.AmountPayment=c.AmountPayment
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles			
			AND f.CodeM='301001'		
			AND a.ReportYear=2015						
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts
					INNER JOIN dbo.t_Case c ON
			r.id=c.rf_idRecordCasePatient	
					INNER JOIN @t v ON
		a.Account=v.Account
		AND c.idRecordCase=v.NumberCase   

UPDATE p SET p.AmountRAK=p.AmountPayment-r.AmountDeduction
FROM @t p INNER JOIN (SELECT rf_idCase,SUM(AmountDeduction) AS AmountDeduction 
							FROM [SRVSQL1-ST2].AccountOMSReports.dbo.t_PaymentAcceptedCase a 
							WHERE DateRegistration>='20150101' AND DateRegistration<'20150811' AND a.CodeM='301001'
							GROUP BY rf_idCase
							) r ON
			p.rf_idCase=r.rf_idCase

UPDATE p SET p.AmountRPD=r.AmountPaymentAccept
FROM @t p INNER JOIN (SELECT rf_idCase,SUM(AmountPaymentAccept) AS AmountPaymentAccept 
							FROM [SRVSQL1-ST2].AccountOMSReports.dbo.t_PaidCase a 
							WHERE DateRegistration>='20150101' AND DateRegistration<'20150811' AND a.CodeM='301001'
							GROUP BY rf_idCase
							) r ON
			p.rf_idCase=r.rf_idCase
SELECT  id ,
        rf_idCase ,
        Account ,
        NumberCase ,
        CodeM ,
        cast(AmountPayment AS MONEY) AS AmountPayment,
        cast(AmountRAK AS MONEY) AS AmountRAK,
        cast(AmountRPD AS MONEY) AS AmountRPD,
        Policy 
FROM @t
ORDER BY id
		       
