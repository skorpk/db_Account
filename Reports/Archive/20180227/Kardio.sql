USE AccountOMS
GO
SELECT v.CodeM,Mes,ENP,DATEADD(DAY,-2,CAST(cast(v.DateEnd AS datetime) AS DATE)) AS DateEnd
INTO #t 
FROM (VALUES('101001','1.12.498','3447030818000152',42766),
('101001','1.17.499','3447030818000152',43034),

('104401','1.12.498','3447040848000197',42809),
('121125','1.12.499','3447040848000197',42872),
('185905','1.12.499','3447040848000197',42912),

('104401','1.12.498','3448020826000210',42915),
('185905','1.16.499','3448020826000210',43018),

('121125','1.16.499','3448040837000215',43005),
('104401','1.16.499','3448040837000215',43096),

('121125','1.16.498','3448140821000567',43014),
('104401','1.16.498','3448140821000567',43091),

('121125','1.12.498','3449530831000467',42871),
('121125','1.16.499','3449530831000467',42992),

('101001','1.16.499','3450540829000243',42992),
('104401','1.16.499','3450540829000243',43097),

('185905','1.17.498','3451730848000246',43014),
('101001','1.17.498','3451730848000246',43035),

('121125','1.12.499','3451830821000195',42754),
('104401','1.16.498','3451830821000195',43049),

('101001','1.12.498','3452430834000073',42755),
('104401','1.16.499','3452430834000073',43034),

('104401','1.12.498','3453730835000595',42936),
('101001','1.16.498','3453730835000595',42975),

('121125','1.12.499','3453740844000254',42810),
('121125','1.12.499','3453740844000254',42858),

('121125','1.16.498','3455240881000323',42949),
('121125','1.16.499','3455240881000323',43053),

('121125','1.16.498','3455340839000332',43039),
('104401','1.16.498','3455340839000332',43056),

('204402','1.12.499','3455340870000050',42919),
('204402','1.17.499','3455340870000050',43047),

('101001','1.12.498','3456140881000506',42913),
('101001','1.17.499','3456140881000506',43014),

('101001','1.12.498','3456320833000586',42782),
('185905','1.12.499','3456320833000586',42810),

('121125','1.12.498','3456540821000393',42779),
('185905','1.12.499','3456540821000393',42858),

('101001','1.16.499','3456730835000329',43020),
('101001','1.17.499','3456730835000329',43047),

('121125','1.16.498','3456830847000117',42983),
('121125','1.16.499','3456830847000117',43025),

('104401','1.12.499','3457630825000231',42780),
('104401','1.16.499','3457630825000231',43060),

('121125','1.12.498','3457740845000242',42871),
('104401','1.12.498','3457740845000242',42886),

('204402','1.12.499','3457740848000553',42853),
('204402','1.12.499','3457740848000553',42912),

('121125','1.12.499','3458330824000055',42781),
('121125','1.12.499','3458330824000055',42851),

('185905','1.12.499','3467060832000263',42915),
('121125','1.12.499','3467060832000263',42941),

('101001','1.12.498','3467160822000396',42831),
('121125','1.12.498','3467160822000396',42866),

('104401','1.12.498','3467350838000254',42754),
('121125','1.12.498','3467350838000254',42895),

('121125','1.12.498','3467350841000176',42900),
('121125','1.16.499','3467350841000176',42983),

('185905','1.12.499','3468850870000210',42886),
('121125','1.16.499','3468850870000210',43000),

('104401','1.12.498','3470050820000503',42801),
('104401','1.12.499','3470050820000503',42937),

('121125','1.12.498','3471950837000322',42830),
('104401','1.12.498','3471950837000322',42885),

('101001','1.12.498','4552040824000137',42830),
('101001','1.17.499','4552040824000137',43034),

('121125','1.12.499','7755230844001151',42871),
('121125','1.12.499','7755230844001151',42913)
) v(CodeM,MES,ENP,DateEnd)

SELECT c.id
INTO #tt
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts					
					INNER JOIN dbo.t_PatientSMO s ON
			r.id=s.rf_idRecordCasePatient           
					INNER JOIN dbo.t_RegisterPatient rp ON
			r.id=rp.rf_idRecordCase
			AND f.id=rp.rf_idFiles       
					INNER JOIN dbo.t_Case c ON
			r.id=c.rf_idRecordCasePatient	
					INNER JOIN dbo.t_MES m ON
			c.id=m.rf_idCase
					INNER JOIN #t tt ON
			f.CodeM=tt.CodeM
			AND s.ENP=tt.ENP
			AND m.MES=tt.MES
			AND c.DateEnd=tt.DateEnd  


SELECT s.ENP,f.CodeM,l.NAMES,m.MES,c.DateBegin,c.DateEnd,d.DS1,a.Account,a.DateRegister,c.idRecordCase,c.AmountPayment,c.AmountPayment-SUM(pp.AmountDeduction),a.rf_idSMO
FROM dbo.t_File f INNER JOIN dbo.t_RegistersAccounts a ON
			f.id=a.rf_idFiles
					INNER JOIN dbo.t_RecordCasePatient r ON
			a.id=r.rf_idRegistersAccounts					
					INNER JOIN dbo.t_PatientSMO s ON
			r.id=s.rf_idRecordCasePatient           
					INNER JOIN dbo.t_RegisterPatient rp ON
			r.id=rp.rf_idRecordCase
			AND f.id=rp.rf_idFiles       
					INNER JOIN dbo.t_Case c ON
			r.id=c.rf_idRecordCasePatient	
					INNER JOIN dbo.t_MES m ON
			c.id=m.rf_idCase
					INNER JOIN #tt tt ON
			c.id=tt.id
					INNER JOIN dbo.vw_Diagnosis d ON
			c.id=d.rf_idCase
					INNER JOIN dbo.vw_sprT001 l ON
			f.CodeM=l.CodeM    
					INNER JOIN dbo.t_PaymentAcceptedCase2 pp ON
			c.id=pp.rf_idCase              
WHERE f.DateRegistration>'20170101' AND a.ReportYear>=2017			    
GROUP BY s.ENP,f.CodeM,l.NAMES,m.MES,c.DateBegin,c.DateEnd,d.DS1,a.Account,a.DateRegister,c.idRecordCase,c.AmountPayment,a.rf_idSMO
GO
DROP TABLE #t	
DROP TABLE #tt		             